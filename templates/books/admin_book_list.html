{% extends 'base/base.html' %}
{% load static %}

{% block title %}Gestion des Livres - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="fas fa-books text-primary"></i>
                Gestion des Livres
            </h1>
            <p class="text-muted">Administration du catalogue de la bibliothèque</p>
        </div>
    </div>

    <!-- Actions administrateur -->
    <div class="row mb-4">
        <div class="col-md-6">
            <form method="get" class="form-inline">
                <div class="input-group" style="width: 100%;">
                    <input type="text" class="form-control" name="q" 
                           placeholder="Rechercher un livre..." 
                           value="{{ current_query }}">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-md-6 text-right">
            <a href="/admin/books/book/add/" class="btn btn-success">
                <i class="fas fa-plus"></i> Ajouter un livre
            </a>
            <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#filtersCollapse">
                <i class="fas fa-filter"></i> Filtres
            </button>
        </div>
    </div>

    <!-- Filtres avancés -->
    <div class="collapse {% if current_category or current_status %}show{% endif %}" id="filtersCollapse">
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row">
                    <div class="col-md-3">
                        <label for="category">Catégorie</label>
                        <select name="category" id="category" class="form-control">
                            <option value="">Toutes les catégories</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" 
                                        {% if current_category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status">Statut</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">Tous les statuts</option>
                            <option value="available" {% if current_status == "available" %}selected{% endif %}>Disponibles</option>
                            <option value="borrowed" {% if current_status == "borrowed" %}selected{% endif %}>Empruntés</option>
                            <option value="inactive" {% if current_status == "inactive" %}selected{% endif %}>Inactifs</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sort">Trier par</label>
                        <select name="sort" id="sort" class="form-control">
                            <option value="-created_at" {% if current_sort == "-created_at" %}selected{% endif %}>Plus récents</option>
                            <option value="created_at" {% if current_sort == "created_at" %}selected{% endif %}>Plus anciens</option>
                            <option value="title" {% if current_sort == "title" %}selected{% endif %}>Titre A-Z</option>
                            <option value="-title" {% if current_sort == "-title" %}selected{% endif %}>Titre Z-A</option>
                            <option value="category__name" {% if current_sort == "category__name" %}selected{% endif %}>Catégorie A-Z</option>
                            <option value="-publication_date" {% if current_sort == "-publication_date" %}selected{% endif %}>Publication récente</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary mr-2">
                            <i class="fas fa-filter"></i> Appliquer
                        </button>
                        <a href="{% url 'books:admin_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Reset
                        </a>
                    </div>
                    {% if current_query %}
                        <input type="hidden" name="q" value="{{ current_query }}">
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Résumé des filtres actifs -->
    {% if current_query or current_category or current_status %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-light border-left border-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Filtres actifs:</small>
                            {% if current_query %}
                                <span class="badge badge-primary mr-1">
                                    <i class="fas fa-search"></i> "{{ current_query }}"
                                </span>
                            {% endif %}
                            {% if current_category %}
                                {% for category in categories %}
                                    {% if category.id|stringformat:"s" == current_category %}
                                        <span class="badge badge-info mr-1">
                                            <i class="fas fa-tag"></i> {{ category.name }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            {% if current_status %}
                                <span class="badge badge-warning mr-1">
                                    <i class="fas fa-filter"></i> 
                                    {% if current_status == "available" %}Disponibles
                                    {% elif current_status == "borrowed" %}Empruntés
                                    {% elif current_status == "inactive" %}Inactifs
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                        <a href="{% url 'books:admin_list' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-times"></i> Effacer tout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Livres</h6>
                            <h4>{{ total_books }}</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Disponibles</h6>
                            <h4>{{ available_books }}</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Empruntés</h6>
                            <h4>{{ borrowed_books }}</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hand-holding fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Catégories</h6>
                            <h4>{{ total_categories }}</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table des livres -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Liste des Livres</h5>
        </div>
        <div class="card-body">
            {% if books %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Titre</th>
                                <th>Auteur(s)</th>
                                <th>Catégorie</th>
                                <th>ISBN</th>
                                <th>Statut</th>
                                <th>Date d'ajout</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for book in books %}
                                <tr>
                                    <td>
                                        <strong>{{ book.title|truncatechars:50 }}</strong>
                                        {% if book.cover_image %}
                                            <i class="fas fa-image text-success" title="Avec image"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for author in book.authors.all %}
                                            {{ author.get_full_name }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="badge badge-info">{{ book.category.name }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ book.isbn|default:"Non renseigné" }}</small>
                                    </td>
                                    <td>
                                        {% if book.is_available %}
                                            <span class="badge badge-success">Disponible</span>
                                        {% else %}
                                            <span class="badge badge-danger">Emprunté</span>
                                        {% endif %}
                                        {% if not book.is_active %}
                                            <span class="badge badge-secondary">Inactif</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ book.created_at|date:"d/m/Y" }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'books:detail' book.pk %}" 
                                               class="btn btn-outline-primary" title="Voir">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="/admin/books/book/{{ book.pk }}/change/" 
                                               class="btn btn-outline-warning" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if book.is_available %}
                                                <button class="btn btn-outline-danger" 
                                                        title="Marquer comme indisponible"
                                                        onclick="toggleAvailability({{ book.pk }})">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-outline-success" 
                                                        title="Marquer comme disponible"
                                                        onclick="toggleAvailability({{ book.pk }})">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="text-muted">
                            <small>
                                Affichage de {{ page_obj.start_index }} à {{ page_obj.end_index }} 
                                sur {{ page_obj.paginator.count }} livre(s) 
                                {% if current_query %}pour "{{ current_query }}"{% endif %}
                            </small>
                        </div>
                        <div>
                            <small class="text-muted">
                                Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                            </small>
                        </div>
                    </div>
                    
                    <nav aria-label="Navigation des pages">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if current_query %}&q={{ current_query }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i> Première
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_query %}&q={{ current_query }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                                        <i class="fas fa-angle-left"></i> Précédente
                                    </a>
                                </li>
                            {% endif %}

                            <!-- Pages numériques -->
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if current_query %}&q={{ current_query }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_query %}&q={{ current_query }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                                        Suivante <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if current_query %}&q={{ current_query }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                                        Dernière <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% else %}
                    {% if books %}
                        <div class="text-center text-muted">
                            <small>{{ books|length }} livre(s) au total</small>
                        </div>
                    {% endif %}
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-search fa-3x text-muted"></i>
                    </div>
                    <div class="alert alert-info border-0">
                        <h5 class="alert-heading">
                            {% if current_query or current_category or current_status %}
                                <i class="fas fa-info-circle"></i> Aucun résultat trouvé
                            {% else %}
                                <i class="fas fa-book-open"></i> Aucun livre dans le catalogue
                            {% endif %}
                        </h5>
                        <p class="mb-3">
                            {% if current_query %}
                                Aucun livre trouvé pour la recherche "<strong>{{ current_query }}</strong>"
                                {% if current_category or current_status %}avec les filtres appliqués{% endif %}.
                            {% elif current_category or current_status %}
                                Aucun livre ne correspond aux critères de filtrage sélectionnés.
                            {% else %}
                                Le catalogue de la bibliothèque est vide. Commencez par ajouter quelques livres.
                            {% endif %}
                        </p>
                        <div class="btn-toolbar justify-content-center">
                            {% if current_query or current_category or current_status %}
                                <a href="{% url 'books:admin_list' %}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times"></i> Effacer les filtres
                                </a>
                            {% endif %}
                            <a href="/admin/books/book/add/" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 
                                {% if current_query or current_category or current_status %}
                                    Ajouter un livre
                                {% else %}
                                    Ajouter le premier livre
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-bolt"></i> Actions Rapides</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="/admin/books/category/" class="btn btn-outline-primary btn-block">
                                <i class="fas fa-tags"></i><br>
                                Gérer les catégories
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/admin/books/author/" class="btn btn-outline-success btn-block">
                                <i class="fas fa-users"></i><br>
                                Gérer les auteurs
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'loans:list' %}" class="btn btn-outline-warning btn-block">
                                <i class="fas fa-handshake"></i><br>
                                Voir les emprunts
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'dashboard:admin' %}" class="btn btn-outline-info btn-block">
                                <i class="fas fa-tachometer-alt"></i><br>
                                Tableau de bord
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleAvailability(bookId) {
    if(confirm('Êtes-vous sûr de vouloir changer la disponibilité de ce livre ?')) {
        // Désactiver le bouton pendant la requête
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Simulation AJAX - à remplacer par une vraie requête
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = originalHTML;
            
            // Afficher un message de succès
            showNotification('Statut mis à jour avec succès', 'success');
            
            // Optionnel: recharger la page pour refléter les changements
            // window.location.reload();
        }, 1000);
        
        // TODO: Implémenter la vraie requête AJAX
        /*
        fetch(`/api/books/${bookId}/toggle-availability/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Statut mis à jour avec succès', 'success');
                // Mettre à jour l'interface
                updateBookStatus(bookId, data.is_available);
            } else {
                showNotification('Erreur lors de la mise à jour', 'error');
            }
        })
        .catch(error => {
            showNotification('Erreur de connexion', 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
        */
    }
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto-hide après 3 secondes
    setTimeout(() => {
        notification.alert('close');
    }, 3000);
}

// Mise à jour automatique des filtres
$(document).ready(function() {
    // Auto-submit du formulaire de recherche après 2 secondes d'inactivité
    let searchTimeout;
    $('input[name="q"]').on('keyup', function() {
        clearTimeout(searchTimeout);
        const form = $(this).closest('form');
        searchTimeout = setTimeout(() => {
            if ($(this).val().length >= 3 || $(this).val().length === 0) {
                form.submit();
            }
        }, 2000);
    });
    
    // Auto-submit des filtres
    $('#category, #status, #sort').on('change', function() {
        $(this).closest('form').submit();
    });
    
    // Raccourcis clavier
    $(document).on('keydown', function(e) {
        // Ctrl + F pour focus sur la recherche
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            $('input[name="q"]').focus().select();
        }
        
        // Ctrl + N pour nouveau livre
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            window.open('/admin/books/book/add/', '_blank');
        }
    });
});
</script>
{% endblock %}
